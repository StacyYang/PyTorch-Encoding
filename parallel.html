

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>encoding.parallel &mdash; Encoding master documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato" type="text/css" />
  <link rel="stylesheet" href="_static/css/encoding.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="encoding.models" href="models.html" />
    <link rel="prev" title="encoding.nn" href="nn.html" /> 


  <script type="text/javascript" src="../_static/js/hidebib.js"></script>    

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/icon.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                master (1.1.1b06042020)
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="notes/compile.html">Install and Citations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="notes/compile.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="notes/compile.html#citations">Citations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="notes/syncbn.html">Implementing Synchronized Multi-GPU Batch Normalization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="notes/syncbn.html#how-bn-works">How BN works?</a></li>
<li class="toctree-l2"><a class="reference internal" href="notes/syncbn.html#why-synchronize-bn">Why Synchronize BN?</a></li>
<li class="toctree-l2"><a class="reference internal" href="notes/syncbn.html#how-to-synchronize">How to Synchronize?</a></li>
<li class="toctree-l2"><a class="reference internal" href="notes/syncbn.html#citation">Citation</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Experiment Systems</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="experiments/cifar.html">EncNet on CIFAR-10</a><ul>
<li class="toctree-l2"><a class="reference internal" href="experiments/cifar.html#test-pre-trained-model">Test Pre-trained Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/cifar.html#train-your-own-model">Train Your Own Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/cifar.html#citation">Citation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="experiments/segmentation.html">Context Encoding for Semantic Segmentation (EncNet)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="experiments/segmentation.html#install-package">Install Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/segmentation.html#test-pre-trained-model">Test Pre-trained Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="experiments/segmentation.html#quick-demo">Quick Demo</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="experiments/segmentation.html#train-your-own-model">Train Your Own Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/segmentation.html#citation">Citation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="experiments/style.html">MSG-Net Style Transfer Example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="experiments/style.html#tabe-of-content">Tabe of content</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/style.html#msg-net">MSG-Net</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/style.html#stylize-images-using-pre-trained-model">Stylize Images Using Pre-trained Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/style.html#train-your-own-msg-net-model">Train Your Own MSG-Net Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/style.html#neural-style">Neural Style</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="experiments/texture.html">Deep TEN: Deep Texture Encoding Network Example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="experiments/texture.html#test-pre-trained-model">Test Pre-trained Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/texture.html#train-your-own-model">Train Your Own Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="experiments/texture.html#citation">Citation</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Package Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="nn.html">encoding.nn</a><ul>
<li class="toctree-l2"><a class="reference internal" href="nn.html#encoding"><span class="hidden-section">Encoding</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="nn.html#syncbatchnorm"><span class="hidden-section">SyncBatchNorm</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="nn.html#batchnorm1d"><span class="hidden-section">BatchNorm1d</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="nn.html#batchnorm2d"><span class="hidden-section">BatchNorm2d</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="nn.html#batchnorm3d"><span class="hidden-section">BatchNorm3d</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="nn.html#inspiration"><span class="hidden-section">Inspiration</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="nn.html#upsampleconv2d"><span class="hidden-section">UpsampleConv2d</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="nn.html#grammatrix"><span class="hidden-section">GramMatrix</span></a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">encoding.parallel</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dataparallelmodel"><span class="hidden-section">DataParallelModel</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataparallelcriterion"><span class="hidden-section">DataParallelCriterion</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="#allreduce"><span class="hidden-section">allreduce</span></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="models.html">encoding.models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="models.html#resnet">ResNet</a><ul>
<li class="toctree-l3"><a class="reference internal" href="models.html#id1"><span class="hidden-section">ResNet</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="models.html#resnet18"><span class="hidden-section">resnet18</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="models.html#resnet34"><span class="hidden-section">resnet34</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="models.html#resnet50"><span class="hidden-section">resnet50</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="models.html#resnet101"><span class="hidden-section">resnet101</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="models.html#resnet152"><span class="hidden-section">resnet152</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">encoding.utils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="utils.html#lr-scheduler"><span class="hidden-section">LR_Scheduler</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html#save-checkpoint"><span class="hidden-section">save_checkpoint</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html#batch-pix-accuracy"><span class="hidden-section">batch_pix_accuracy</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html#batch-intersection-union"><span class="hidden-section">batch_intersection_union</span></a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Encoding</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>encoding.parallel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/parallel.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="encoding-parallel">
<h1>encoding.parallel<a class="headerlink" href="#encoding-parallel" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Current PyTorch DataParallel Table is not supporting mutl-gpu loss calculation, which makes the gpu memory usage very in-balance. We address this issue here by doing DataParallel for Model &amp; Criterion.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This code is provided together with the paper</p>
<ul class="simple">
<li><p>Hang Zhang, Kristin Dana, Jianping Shi, Zhongyue Zhang, Xiaogang Wang, Ambrish Tyagi, Amit Agrawal. “Context Encoding for Semantic Segmentation”  <em>The IEEE Conference on Computer Vision and Pattern Recognition (CVPR) 2018</em></p></li>
</ul>
</div>
<span class="target" id="module-encoding.parallel"></span><p>Encoding Data Parallel</p>
<div class="section" id="dataparallelmodel">
<h2><span class="hidden-section">DataParallelModel</span><a class="headerlink" href="#dataparallelmodel" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="encoding.parallel.DataParallelModel">
<em class="property">class </em><code class="sig-prename descclassname">encoding.parallel.</code><code class="sig-name descname">DataParallelModel</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">module</span></em>, <em class="sig-param"><span class="n">device_ids</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">output_device</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">dim</span><span class="o">=</span><span class="default_value">0</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/encoding/parallel.html#DataParallelModel"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#encoding.parallel.DataParallelModel" title="Permalink to this definition">¶</a></dt>
<dd><p>Implements data parallelism at the module level.</p>
<p>This container parallelizes the application of the given module by
splitting the input across the specified devices by chunking in the
batch dimension.
In the forward pass, the module is replicated on each device,
and each replica handles a portion of the input. During the backwards pass, gradients from each replica are summed into the original module.
Note that the outputs are not gathered, please use compatible
<a class="reference internal" href="#encoding.parallel.DataParallelCriterion" title="encoding.parallel.DataParallelCriterion"><code class="xref py py-class docutils literal notranslate"><span class="pre">encoding.parallel.DataParallelCriterion</span></code></a>.</p>
<p>The batch size should be larger than the number of GPUs used. It should
also be an integer multiple of the number of GPUs so that each chunk is
the same size (so that each GPU processes the same number of samples).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>module</strong> – module to be parallelized</p></li>
<li><p><strong>device_ids</strong> – CUDA devices (default: all devices)</p></li>
</ul>
</dd>
</dl>
<dl class="simple">
<dt>Reference:</dt><dd><p>Hang Zhang, Kristin Dana, Jianping Shi, Zhongyue Zhang, Xiaogang Wang, Ambrish Tyagi,
Amit Agrawal. “Context Encoding for Semantic Segmentation.
<em>The IEEE Conference on Computer Vision and Pattern Recognition (CVPR) 2018</em></p>
</dd>
</dl>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallelModel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="dataparallelcriterion">
<h2><span class="hidden-section">DataParallelCriterion</span><a class="headerlink" href="#dataparallelcriterion" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="encoding.parallel.DataParallelCriterion">
<em class="property">class </em><code class="sig-prename descclassname">encoding.parallel.</code><code class="sig-name descname">DataParallelCriterion</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">module</span></em>, <em class="sig-param"><span class="n">device_ids</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">output_device</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">dim</span><span class="o">=</span><span class="default_value">0</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/encoding/parallel.html#DataParallelCriterion"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#encoding.parallel.DataParallelCriterion" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate loss in multiple-GPUs, which balance the memory usage for
Semantic Segmentation.</p>
<p>The targets are splitted across the specified devices by chunking in
the batch dimension. Please use together with <a class="reference internal" href="#encoding.parallel.DataParallelModel" title="encoding.parallel.DataParallelModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">encoding.parallel.DataParallelModel</span></code></a>.</p>
<dl class="simple">
<dt>Reference:</dt><dd><p>Hang Zhang, Kristin Dana, Jianping Shi, Zhongyue Zhang, Xiaogang Wang, Ambrish Tyagi,
Amit Agrawal. “Context Encoding for Semantic Segmentation.
<em>The IEEE Conference on Computer Vision and Pattern Recognition (CVPR) 2018</em></p>
</dd>
</dl>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">net</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallelModel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">criterion</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallelCriterion</span><span class="p">(</span><span class="n">criterion</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
<dl class="py method">
<dt id="encoding.parallel.DataParallelCriterion.forward">
<code class="sig-name descname">forward</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">targets</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/encoding/parallel.html#DataParallelCriterion.forward"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#encoding.parallel.DataParallelCriterion.forward" title="Permalink to this definition">¶</a></dt>
<dd><p>Defines the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Although the recipe for forward pass needs to be defined within
this function, one should call the <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code> instance afterwards
instead of this since the former takes care of running the
registered hooks while the latter silently ignores them.</p>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="allreduce">
<h2><span class="hidden-section">allreduce</span><a class="headerlink" href="#allreduce" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt id="encoding.parallel.allreduce">
<code class="sig-prename descclassname">encoding.parallel.</code><code class="sig-name descname">allreduce</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">inputs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/encoding/parallel.html#allreduce"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#encoding.parallel.allreduce" title="Permalink to this definition">¶</a></dt>
<dd><p>Cross GPU all reduce autograd operation for calculate mean and
variance in SyncBN.</p>
</dd></dl>

</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="models.html" class="btn btn-neutral float-right" title="encoding.models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="nn.html" class="btn btn-neutral float-left" title="encoding.nn" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Hang Zhang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>